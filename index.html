<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üêâ Cronache del Destino</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        :root {
            --parchment: #f4e4bc;
            --parchment-dark: #d4c4a0;
            --ink: #2c1810;
            --ink-light: #5c4030;
            --gold: #c9a227;
            --gold-dark: #8b6914;
            --blood: #8b0000;
            --emerald: #2e8b57;
            --sapphire: #1e3a5f;
            --shadow: rgba(0,0,0,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Crimson Text', Georgia, serif;
            background: linear-gradient(135deg, #1a0f0a 0%, #2c1810 50%, #1a0f0a 100%);
            min-height: 100vh;
            min-height: 100dvh;
            color: var(--ink);
            overflow-x: hidden;
        }

        /* ==================== SCREENS ==================== */
        .screen {
            display: none;
            min-height: 100vh;
            min-height: 100dvh;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        /* ==================== HOMEPAGE ==================== */
        #home-screen {
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: 
                radial-gradient(ellipse at center, rgba(201, 162, 39, 0.1) 0%, transparent 70%),
                linear-gradient(135deg, #1a0f0a 0%, #2c1810 50%, #1a0f0a 100%);
        }

        .home-container {
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .home-logo {
            font-size: 5em;
            margin-bottom: 10px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .home-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5em;
            color: var(--gold);
            text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
            margin-bottom: 5px;
        }

        .home-subtitle {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.1em;
            color: var(--parchment-dark);
            margin-bottom: 40px;
        }

        .home-menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .home-btn {
            padding: 18px 30px;
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            background: linear-gradient(180deg, var(--parchment), var(--parchment-dark));
            border: 3px solid var(--gold-dark);
            border-radius: 12px;
            color: var(--ink);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px var(--shadow);
        }

        .home-btn:hover, .home-btn:active {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--shadow);
            border-color: var(--gold);
        }

        .home-btn.primary {
            background: linear-gradient(180deg, var(--gold), var(--gold-dark));
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .home-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .home-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--gold-dark);
        }

        .home-section-title {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            margin-bottom: 15px;
        }

        /* ==================== GAME SCREEN ==================== */
        #game-screen {
            background: linear-gradient(180deg, rgba(244, 228, 188, 0.95), rgba(212, 196, 160, 0.92));
        }

        /* Top Bar */
        .game-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: linear-gradient(180deg, var(--ink), #1a0f0a);
            border-bottom: 2px solid var(--gold);
            gap: 8px;
            flex-wrap: wrap;
        }

        .topbar-left, .topbar-right {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .topbar-center {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            justify-content: center;
            min-width: 0;
            flex-wrap: wrap;
        }

        @media (max-width: 550px) {
            .topbar-center {
                gap: 5px;
            }
            .time-display {
                padding: 3px 8px;
                font-size: 0.75em;
            }
            .mini-stats {
                gap: 5px;
            }
        }

        .topbar-btn {
            padding: 8px 12px;
            font-size: 1.1em;
            background: linear-gradient(180deg, var(--gold), var(--gold-dark));
            border: 2px solid var(--gold);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .topbar-btn:hover, .topbar-btn:active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(201, 162, 39, 0.5);
        }

        .topbar-btn.danger {
            background: linear-gradient(180deg, var(--blood), #5c0000);
            border-color: var(--blood);
        }

        .topbar-btn span.label {
            font-family: 'Cinzel', serif;
            font-size: 0.75em;
        }

        @media (max-width: 500px) {
            .topbar-btn span.label {
                display: none;
            }
        }

        /* Character Mini Stats */
        .mini-stats {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Time Display */
        .time-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            font-family: 'Cinzel', serif;
            font-size: 0.85em;
            color: var(--parchment);
        }

        .time-day {
            color: var(--gold);
        }

        .time-clock {
            font-weight: bold;
        }

        .time-period {
            font-size: 1.1em;
        }

        .mini-stat {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.9em;
            color: var(--parchment);
            font-family: 'Cinzel', serif;
        }

        .mini-stat-bar {
            width: 50px;
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .mini-stat-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .mini-stat-fill.health { background: linear-gradient(90deg, #dc143c, #ff6b6b); }
        .mini-stat-fill.mana { background: linear-gradient(90deg, #4169e1, #87ceeb); }

        /* Story Area - MAIN FOCUS */
        .story-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .story-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 10px;
        }

        .story-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .story-scroll::-webkit-scrollbar-track {
            background: var(--parchment-dark);
        }

        .story-scroll::-webkit-scrollbar-thumb {
            background: var(--gold-dark);
            border-radius: 4px;
        }

        .story-entry {
            margin-bottom: 20px;
            animation: fadeIn 0.4s ease;
            line-height: 1.8;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .story-entry.narrator {
            font-size: 1.2em;
            padding: 18px 22px;
            background: rgba(201, 162, 39, 0.12);
            border-left: 4px solid var(--gold);
            border-radius: 0 12px 12px 0;
            line-height: 1.7;
        }

        .story-entry.narrator p {
            margin: 0 0 14px 0;
        }

        .story-entry.narrator p:last-child {
            margin-bottom: 0;
        }

        .story-entry.narrator em {
            color: var(--ink-light);
            font-style: italic;
        }

        .story-entry.player {
            font-size: 1.1em;
            padding: 12px 20px;
            background: rgba(30, 58, 95, 0.15);
            border-left: 4px solid var(--sapphire);
            border-radius: 0 12px 12px 0;
            font-weight: 500;
        }

        .story-entry.player p {
            margin: 0;
        }

        .story-entry.dice-roll {
            font-size: 1em;
            padding: 10px 15px;
            background: rgba(139, 0, 0, 0.12);
            border-left: 4px solid var(--blood);
            border-radius: 0 12px 12px 0;
            font-family: 'Cinzel', serif;
        }

        .story-entry.system {
            font-size: 0.95em;
            padding: 10px 15px;
            background: rgba(46, 139, 87, 0.12);
            border-left: 4px solid var(--emerald);
            border-radius: 0 12px 12px 0;
            font-style: italic;
        }

        /* Choices */
        .choices-area {
            padding: 15px 20px;
            background: rgba(0,0,0,0.05);
            border-top: 1px solid var(--gold-dark);
        }

        .choice-btn {
            width: 100%;
            padding: 14px 20px;
            margin-bottom: 10px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1em;
            background: linear-gradient(180deg, var(--parchment), var(--parchment-dark));
            border: 2px solid var(--gold-dark);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            color: var(--ink);
        }

        .choice-btn:last-child {
            margin-bottom: 0;
        }

        .choice-btn:hover, .choice-btn:active {
            background: linear-gradient(180deg, #fff8e8, var(--parchment));
            transform: translateX(5px);
            border-color: var(--gold);
        }

        .choice-dc {
            float: right;
            font-size: 0.8em;
            padding: 3px 10px;
            background: var(--gold-dark);
            color: white;
            border-radius: 10px;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.03);
            border-top: 1px solid var(--gold-dark);
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-btn {
            padding: 8px 14px;
            font-family: 'Crimson Text', serif;
            font-size: 0.95em;
            background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(240,230,210,0.9));
            border: 1px solid var(--gold-dark);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--ink);
        }

        .quick-btn:hover, .quick-btn:active {
            background: linear-gradient(180deg, var(--gold), var(--gold-dark));
            color: white;
            transform: scale(1.05);
        }

        /* Suggestions (optional, not forced) */
        .suggestions-area {
            padding: 12px 15px;
            background: rgba(201, 162, 39, 0.08);
            border-top: 1px solid var(--gold-dark);
        }

        .suggestions-label {
            font-size: 0.85em;
            color: var(--ink-light);
            margin-bottom: 8px;
            font-style: italic;
        }

        .suggestions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-btn {
            padding: 10px 16px;
            font-family: 'Crimson Text', serif;
            font-size: 1em;
            background: linear-gradient(180deg, var(--parchment), var(--parchment-dark));
            border: 2px solid var(--gold-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--ink);
            text-align: left;
            flex: 1 1 auto;
            min-width: 150px;
        }

        .suggestion-btn:hover, .suggestion-btn:active {
            background: linear-gradient(180deg, #fff8e8, var(--parchment));
            border-color: var(--gold);
            transform: translateY(-2px);
        }

        .suggestion-btn .suggestion-type {
            font-size: 0.8em;
            color: var(--gold-dark);
            display: block;
            margin-bottom: 2px;
        }

        /* Input Area Enhanced */
        .input-area {
            padding: 15px 20px;
            background: rgba(0,0,0,0.08);
            border-top: 2px solid var(--gold-dark);
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .action-input {
            flex: 1;
            padding: 14px 18px;
            font-family: 'Crimson Text', serif;
            font-size: 1.15em;
            border: 2px solid var(--gold-dark);
            border-radius: 10px;
            background: white;
            color: var(--ink);
        }

        .action-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(201, 162, 39, 0.3);
        }

        .action-input::placeholder {
            color: var(--ink-light);
            font-style: italic;
        }

        .input-hints {
            margin-top: 8px;
            font-size: 0.8em;
            color: var(--ink-light);
            text-align: center;
            font-style: italic;
        }

        .send-btn {
            padding: 14px 25px;
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            background: linear-gradient(180deg, var(--gold), var(--gold-dark));
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-btn:hover, .send-btn:active {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* NPC Dialogue styling */
        .story-entry.dialogue {
            font-size: 1.15em;
            padding: 15px 20px;
            background: rgba(139, 69, 19, 0.1);
            border-left: 4px solid #8B4513;
            border-radius: 0 12px 12px 0;
        }

        .story-entry .npc-name {
            font-family: 'Cinzel', serif;
            font-weight: bold;
            color: var(--gold-dark);
            display: block;
            margin-bottom: 5px;
        }

        .story-entry .dialogue-text {
            font-style: italic;
            color: var(--ink);
        }

        .story-entry .player-speech {
            color: var(--sapphire);
            font-weight: 500;
        }

        /* ==================== MODALS ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(180deg, var(--parchment), var(--parchment-dark));
            border: 3px solid var(--gold);
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(90deg, var(--gold-dark), var(--gold), var(--gold-dark));
            color: white;
            font-family: 'Cinzel', serif;
            font-size: 1.3em;
        }

        .modal-close {
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            border: none;
            background: none;
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        /* ==================== SPECIFIC MODALS ==================== */

        /* Dice Modal */
        .dice-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .dice-btn {
            aspect-ratio: 1;
            font-family: 'Cinzel', serif;
            font-size: 1.5em;
            font-weight: bold;
            border: 3px solid var(--ink);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .dice-btn:hover, .dice-btn:active {
            transform: scale(1.1) rotate(5deg);
        }

        .dice-btn.d20 { background: linear-gradient(135deg, #dc143c, #8b0000); color: white; }
        .dice-btn.d12 { background: linear-gradient(135deg, #4169e1, #1e3a5f); color: white; }
        .dice-btn.d10 { background: linear-gradient(135deg, #9932cc, #4b0082); color: white; }
        .dice-btn.d8 { background: linear-gradient(135deg, #ffd700, #b8860b); color: var(--ink); }
        .dice-btn.d6 { background: linear-gradient(135deg, #3cb371, #2e8b57); color: white; }
        .dice-btn.d4 { background: linear-gradient(135deg, #ff8c00, #ff4500); color: white; }

        .dice-label {
            font-size: 0.5em;
            opacity: 0.8;
        }

        .dice-result {
            text-align: center;
            padding: 20px;
            margin-top: 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            font-family: 'Cinzel', serif;
            font-size: 2em;
            color: var(--gold-dark);
        }

        /* Inventory Modal */
        .currency-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 20px;
            font-family: 'Cinzel', serif;
            font-weight: bold;
        }

        .inv-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .inv-slot {
            aspect-ratio: 1;
            background: rgba(0,0,0,0.15);
            border: 2px solid var(--ink-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .inv-slot:hover {
            background: rgba(201, 162, 39, 0.2);
            border-color: var(--gold);
        }

        .inv-slot .count {
            position: absolute;
            bottom: 2px;
            right: 5px;
            font-size: 0.4em;
            font-weight: bold;
        }

        .equip-row {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .equip-slot {
            width: 70px;
            height: 70px;
            background: rgba(201, 162, 39, 0.2);
            border: 2px solid var(--gold);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
        }

        .equip-label {
            font-size: 0.35em;
            font-family: 'Cinzel', serif;
            color: var(--ink-light);
        }

        /* Character Modal */
        .char-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .char-portrait {
            font-size: 4em;
            margin-bottom: 10px;
        }

        .char-name {
            font-family: 'Cinzel', serif;
            font-size: 1.5em;
        }

        .char-class {
            color: var(--ink-light);
            font-style: italic;
        }

        .stats-section {
            margin-bottom: 20px;
        }

        .stat-row {
            margin-bottom: 10px;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        .stat-bar {
            height: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .stat-fill.health { background: linear-gradient(90deg, #8b0000, #dc143c); }
        .stat-fill.mana { background: linear-gradient(90deg, #1e3a5f, #4169e1); }
        .stat-fill.stamina { background: linear-gradient(90deg, #2e8b57, #3cb371); }
        .stat-fill.exp { background: linear-gradient(90deg, #8b6914, #ffd700); }

        .attrs-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .attr-box {
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
            border: 1px solid var(--gold-dark);
        }

        .attr-name {
            font-size: 0.8em;
            color: var(--ink-light);
        }

        .attr-value {
            font-family: 'Cinzel', serif;
            font-size: 1.5em;
            font-weight: bold;
        }

        .attr-mod {
            font-size: 0.9em;
            color: var(--gold-dark);
        }

        /* Skills Section */
        .skills-section h3 {
            font-family: 'Cinzel', serif;
            margin-bottom: 10px;
            color: var(--ink);
        }

        .skill-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .skill-bonus { color: var(--emerald); font-weight: bold; }
        .skill-malus { color: var(--blood); font-weight: bold; }

        /* Stories/Save Modals */
        .story-card, .save-slot {
            padding: 15px;
            background: rgba(255,255,255,0.5);
            border: 2px solid var(--gold-dark);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .story-card:hover, .save-slot:hover,
        .story-card.selected, .save-slot.selected {
            border-color: var(--gold);
            background: rgba(201, 162, 39, 0.2);
        }

        .story-card-title, .save-slot-title {
            font-family: 'Cinzel', serif;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .story-card-desc, .save-slot-info {
            font-size: 0.9em;
            color: var(--ink-light);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-family: 'Cinzel', serif;
            margin-bottom: 5px;
            color: var(--ink);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            font-family: 'Crimson Text', serif;
            font-size: 1em;
            border: 2px solid var(--gold-dark);
            border-radius: 8px;
            background: white;
            color: var(--ink);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--gold);
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            font-family: 'Cinzel', serif;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn.primary {
            background: linear-gradient(180deg, var(--gold), var(--gold-dark));
            color: white;
        }

        .btn.secondary {
            background: linear-gradient(180deg, var(--parchment), var(--parchment-dark));
            border: 2px solid var(--gold-dark);
            color: var(--ink);
        }

        .btn.danger {
            background: linear-gradient(180deg, var(--blood), #5c0000);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Character Creation */
        .creation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }

        .creation-option {
            padding: 10px 5px;
            text-align: center;
            background: rgba(0,0,0,0.1);
            border: 2px solid var(--gold-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .creation-option:hover, .creation-option.selected {
            border-color: var(--gold);
            background: rgba(201, 162, 39, 0.2);
            transform: scale(1.05);
        }

        .creation-icon {
            font-size: 1.8em;
        }

        .creation-name {
            font-family: 'Cinzel', serif;
            font-size: 0.7em;
            margin-top: 3px;
            line-height: 1.2;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--ink);
            color: var(--parchment);
            border-radius: 10px;
            border-left: 4px solid var(--gold);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        /* Wait Modal */
        .time-current {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .wait-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .wait-btn {
            padding: 12px;
            font-family: 'Cinzel', serif;
            font-size: 0.9em;
            background: linear-gradient(180deg, var(--parchment), var(--parchment-dark));
            border: 2px solid var(--gold-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .wait-btn:hover {
            background: linear-gradient(180deg, var(--gold), var(--gold-dark));
            color: white;
            transform: scale(1.05);
        }

        .wait-custom {
            display: flex;
            gap: 10px;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid var(--gold-dark);
        }

        .wait-custom .form-select {
            flex: 1;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .notification.success { border-left-color: var(--emerald); }
        .notification.error { border-left-color: var(--blood); }

        /* Loading */
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Settings */
        .settings-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
        }

        .settings-section h3 {
            font-family: 'Cinzel', serif;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <!-- ==================== HOME SCREEN ==================== -->
    <div id="home-screen" class="screen active">
        <div class="home-container">
            <div class="home-logo">üêâ</div>
            <h1 class="home-title">Cronache del Destino</h1>
            <p class="home-subtitle">Un'Avventura Narrativa con IA</p>

            <div class="home-menu">
                <button class="home-btn primary" id="btn-continue" disabled>‚ñ∂Ô∏è Continua</button>
                <button class="home-btn" id="btn-new-game">üÜï Nuova Partita</button>
                <button class="home-btn" id="btn-load-game">üìÇ Carica Partita</button>
                <button class="home-btn" id="btn-stories">üìú Gestisci Storie</button>
                <button class="home-btn" id="btn-settings">‚öôÔ∏è Impostazioni</button>
            </div>
        </div>
    </div>

    <!-- ==================== GAME SCREEN ==================== -->
    <div id="game-screen" class="screen">
        <!-- Top Bar -->
        <div class="game-topbar">
            <div class="topbar-left">
                <button class="topbar-btn danger" id="btn-exit">üö™</button>
                <button class="topbar-btn" id="btn-save-quick">üíæ</button>
            </div>

            <div class="topbar-center">
                <div class="time-display" id="time-display">
                    <span class="time-day" id="time-day">Giorno 1</span>
                    <span class="time-clock" id="time-clock">08:00</span>
                    <span class="time-period" id="time-period">üåÖ</span>
                </div>
                <div class="mini-stats">
                    <div class="mini-stat">
                        ‚ù§Ô∏è
                        <div class="mini-stat-bar">
                            <div class="mini-stat-fill health" id="mini-health" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="mini-stat">
                        üíô
                        <div class="mini-stat-bar">
                            <div class="mini-stat-fill mana" id="mini-mana" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="topbar-right">
                <button class="topbar-btn" id="btn-wait" title="Fai passare il tempo">‚è∞</button>
                <button class="topbar-btn" id="btn-dice">üé≤</button>
                <button class="topbar-btn" id="btn-inventory">üéí</button>
                <button class="topbar-btn" id="btn-character">üë§</button>
            </div>
        </div>

        <!-- Story Area -->
        <div class="story-area">
            <div class="story-scroll" id="story-scroll">
                <!-- Story entries appear here -->
            </div>

            <!-- Quick Actions (dynamic based on genre) -->
            <div class="quick-actions" id="quick-actions">
                <!-- Populated by updateQuickActions() -->
            </div>

            <!-- Suggestions (not forced choices) -->
            <div class="suggestions-area" id="suggestions-area" style="display: none;">
                <div class="suggestions-label">üí° Suggerimenti (o scrivi quello che vuoi):</div>
                <div class="suggestions-list" id="suggestions-list"></div>
            </div>

            <div class="input-area">
                <div class="input-row">
                    <input type="text" class="action-input" id="action-input" placeholder="Scrivi cosa fai, dici o chiedi...">
                    <button class="send-btn" id="btn-send">‚û§</button>
                </div>
                <div class="input-hints">
                    Esempi: "Chiedo al mercante il suo nome" ‚Ä¢ "Esamino la stanza" ‚Ä¢ "Dico: Salve, straniero!"
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Dice Modal -->
    <div class="modal-overlay" id="modal-dice">
        <div class="modal">
            <div class="modal-header">
                üé≤ Lancia i Dadi
                <button class="modal-close" data-close="modal-dice">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="dice-grid">
                    <button class="dice-btn d20" data-sides="20"><span>D20</span><span class="dice-label">Fato</span></button>
                    <button class="dice-btn d12" data-sides="12"><span>D12</span><span class="dice-label">Danno</span></button>
                    <button class="dice-btn d10" data-sides="10"><span>D10</span><span class="dice-label">%</span></button>
                    <button class="dice-btn d8" data-sides="8"><span>D8</span><span class="dice-label">Arma</span></button>
                    <button class="dice-btn d6" data-sides="6"><span>D6</span><span class="dice-label">Base</span></button>
                    <button class="dice-btn d4" data-sides="4"><span>D4</span><span class="dice-label">Min</span></button>
                </div>
                <div class="dice-result" id="dice-result">Scegli un dado</div>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div class="modal-overlay" id="modal-inventory">
        <div class="modal">
            <div class="modal-header">
                üéí Inventario
                <button class="modal-close" data-close="modal-inventory">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="currency-row">
                    <div class="currency-item">üíµ <span id="inv-gold">0</span></div>
                </div>
                <div class="inv-grid" id="inv-grid"></div>
                <h4 style="font-family: 'Cinzel', serif; margin: 15px 0 10px;">Equipaggiato</h4>
                <div class="equip-row">
                    <div class="equip-slot" id="equip-weapon">‚öîÔ∏è<span class="equip-label">Arma</span></div>
                    <div class="equip-slot" id="equip-armor">üõ°Ô∏è<span class="equip-label">Armatura</span></div>
                    <div class="equip-slot" id="equip-accessory">üíç<span class="equip-label">Accessorio</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Modal -->
    <div class="modal-overlay" id="modal-character">
        <div class="modal">
            <div class="modal-header">
                üë§ Personaggio
                <button class="modal-close" data-close="modal-character">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="char-header">
                    <div class="char-portrait" id="char-portrait">üßô</div>
                    <div class="char-name" id="char-name">Eroe</div>
                    <div class="char-class" id="char-class">Avventuriero Lv. 1</div>
                </div>

                <div class="stats-section">
                    <div class="stat-row">
                        <div class="stat-label"><span>‚ù§Ô∏è Salute</span><span id="stat-health-text">100/100</span></div>
                        <div class="stat-bar"><div class="stat-fill health" id="stat-health" style="width: 100%"></div></div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label"><span>üíô Mana</span><span id="stat-mana-text">50/50</span></div>
                        <div class="stat-bar"><div class="stat-fill mana" id="stat-mana" style="width: 100%"></div></div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label"><span>üíö Stamina</span><span id="stat-stamina-text">100/100</span></div>
                        <div class="stat-bar"><div class="stat-fill stamina" id="stat-stamina" style="width: 100%"></div></div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label"><span>‚≠ê Esperienza</span><span id="stat-exp-text">0/100</span></div>
                        <div class="stat-bar"><div class="stat-fill exp" id="stat-exp" style="width: 0%"></div></div>
                    </div>
                </div>

                <div class="attrs-grid" id="attrs-grid"></div>

                <div class="skills-section" style="margin-top: 20px;">
                    <h3>üìö Abilit√†</h3>
                    <div id="skills-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stories Modal -->
    <div class="modal-overlay" id="modal-stories">
        <div class="modal">
            <div class="modal-header">
                üìú Storie
                <button class="modal-close" data-close="modal-stories">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="stories-list"></div>
                <div class="btn-row">
                    <button class="btn primary" id="btn-create-story">‚ûï Nuova</button>
                    <button class="btn secondary" id="btn-edit-story" disabled>‚úèÔ∏è Modifica</button>
                    <button class="btn danger" id="btn-delete-story" disabled>üóëÔ∏è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Story Editor Modal -->
    <div class="modal-overlay" id="modal-story-editor">
        <div class="modal">
            <div class="modal-header">
                ‚úèÔ∏è Editor Storia
                <button class="modal-close" data-close="modal-story-editor">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Titolo</label>
                    <input type="text" class="form-input" id="edit-story-title" placeholder="Nome della storia...">
                </div>
                <div class="form-group">
                    <label class="form-label">Genere/Ambientazione</label>
                    <select class="form-select" id="edit-story-setting">
                        <option value="Fantasy Medievale">üè∞ Fantasy Medievale</option>
                        <option value="Fantasy Gotico">üåë Fantasy Gotico / Dark</option>
                        <option value="Fantasy Epico">‚öîÔ∏è Fantasy Epico</option>
                        <option value="Fantascienza">üöÄ Fantascienza</option>
                        <option value="Cyberpunk">üåÉ Cyberpunk</option>
                        <option value="Contemporaneo">üèôÔ∏è Contemporaneo / Moderno</option>
                        <option value="Slice of Life">‚òï Slice of Life</option>
                        <option value="Business">üíº Business / Economia</option>
                        <option value="Horror">üëª Horror</option>
                        <option value="Thriller">üîç Thriller / Mistero</option>
                        <option value="Romantico">üíï Romantico</option>
                        <option value="Storico">üìú Storico</option>
                        <option value="Post-Apocalittico">‚ò¢Ô∏è Post-Apocalittico</option>
                        <option value="Supereroi">ü¶∏ Supereroi</option>
                        <option value="Orientale">üèØ Orientale / Wuxia</option>
                        <option value="Piratesco">üè¥‚Äç‚ò†Ô∏è Piratesco</option>
                        <option value="Western">ü§† Western</option>
                        <option value="Steampunk">‚öôÔ∏è Steampunk</option>
                        <option value="Altro">üìù Altro (specifica nella descrizione)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Difficolt√†</label>
                    <select class="form-select" id="edit-story-difficulty">
                        <option value="easy">üü¢ Facile</option>
                        <option value="normal">üü° Normale</option>
                        <option value="hard">üî¥ Difficile</option>
                        <option value="nightmare">üíÄ Incubo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descrizione Mondo</label>
                    <textarea class="form-textarea" id="edit-story-desc" placeholder="Descrivi l'ambientazione..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Personalit√† Narratore IA</label>
                    <textarea class="form-textarea" id="edit-story-personality" placeholder="Come deve narrare l'IA?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Profondit√† Gioco</label>
                    <textarea class="form-textarea" id="edit-story-depth" placeholder="Meccaniche speciali, karma, NPC..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Prologo</label>
                    <textarea class="form-textarea" id="edit-story-prologue" placeholder="L'inizio della storia..."></textarea>
                </div>
                <div class="btn-row">
                    <button class="btn primary" id="btn-save-story">üíæ Salva</button>
                    <button class="btn secondary" data-close="modal-story-editor">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Creation Modal -->
    <div class="modal-overlay" id="modal-new-game">
        <div class="modal">
            <div class="modal-header">
                üÜï Nuova Partita
                <button class="modal-close" data-close="modal-new-game">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Scegli Storia</label>
                    <select class="form-select" id="new-game-story"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nome Personaggio</label>
                    <input type="text" class="form-input" id="new-game-name" placeholder="Il tuo nome...">
                </div>
                <div class="form-group">
                    <label class="form-label">Origine (da dove vieni)</label>
                    <div class="creation-grid" id="origin-grid"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Archetipo (chi sei)</label>
                    <div class="creation-grid" id="archetype-grid"></div>
                </div>
                <div class="btn-row">
                    <button class="btn primary" id="btn-start-game">üöÄ Inizia Avventura</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save/Load Modal -->
    <div class="modal-overlay" id="modal-saves">
        <div class="modal">
            <div class="modal-header">
                üíæ Salvataggi
                <button class="modal-close" data-close="modal-saves">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="saves-list"></div>
                <div class="btn-row">
                    <button class="btn primary" id="btn-save-to-slot">üíæ Salva</button>
                    <button class="btn secondary" id="btn-load-from-slot">üìÇ Carica</button>
                    <button class="btn danger" id="btn-delete-slot">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="modal-settings">

    <!-- Wait/Time Modal -->
    <div class="modal-overlay" id="modal-wait">
        <div class="modal">
            <div class="modal-header">
                ‚è∞ Passa il Tempo
                <button class="modal-close" data-close="modal-wait">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="time-current">
                    <strong id="wait-current-time">Luned√¨, Giorno 1 - 08:00</strong>
                </div>
                <div class="wait-options">
                    <button class="wait-btn" data-minutes="30">30 minuti</button>
                    <button class="wait-btn" data-minutes="60">1 ora</button>
                    <button class="wait-btn" data-minutes="180">3 ore</button>
                    <button class="wait-btn" data-minutes="360">6 ore</button>
                    <button class="wait-btn" data-minutes="720">12 ore</button>
                    <button class="wait-btn" data-minutes="1440">1 giorno</button>
                    <button class="wait-btn" data-minutes="10080">1 settimana</button>
                </div>
                <div class="wait-custom">
                    <label class="form-label">Aspetta fino a:</label>
                    <select class="form-select" id="wait-until-hour">
                        <option value="6">06:00 - Alba</option>
                        <option value="8">08:00 - Mattina</option>
                        <option value="12">12:00 - Mezzogiorno</option>
                        <option value="18">18:00 - Sera</option>
                        <option value="21">21:00 - Notte</option>
                        <option value="0">00:00 - Mezzanotte</option>
                    </select>
                    <button class="btn secondary" id="btn-wait-until">Aspetta</button>
                </div>
            </div>
        </div>
    </div>
        <div class="modal">
            <div class="modal-header">
                ‚öôÔ∏è Impostazioni
                <button class="modal-close" data-close="modal-settings">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>üîë API Keys</h3>
                    <div class="form-group">
                        <label class="form-label">Groq (Llama 3.1 8B)</label>
                        <input type="password" class="form-input" id="set-groq-key" placeholder="gsk_...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">OpenRouter (Gemma 3 27B)</label>
                        <input type="password" class="form-input" id="set-openrouter-key" placeholder="sk-or-...">
                    </div>
                </div>
                <div class="settings-section">
                    <h3>ü§ñ Modello IA</h3>
                    <div class="form-group">
                        <select class="form-select" id="set-model">
                            <option value="groq">Groq - Llama 3.1 8B (Veloce)</option>
                            <option value="openrouter">OpenRouter - Gemma 3 27B</option>
                            <option value="auto">Auto</option>
                        </select>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>üéÆ Gioco</h3>
                    <div class="form-group">
                        <label class="form-label">Lunghezza Risposte</label>
                        <select class="form-select" id="set-length">
                            <option value="short">Breve</option>
                            <option value="medium" selected>Media</option>
                            <option value="long">Lunga</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="set-autoroll" checked> Tiri automatici</label>
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn primary" id="btn-save-settings">üíæ Salva</button>
                    <button class="btn danger" id="btn-reset-all">‚ö†Ô∏è Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GAME STATE ====================
        const G = {
            currentStory: null,
            character: null,
            storyLog: [],
            history: [],
            time: {
                day: 1,
                hour: 8,
                minute: 0,
                dayName: 'Luned√¨',
                season: 'Primavera'
            },
            settings: {
                groqKey: '', openrouterKey: '', model: 'groq', length: 'medium', autoRoll: true
            },
            stories: [],
            saves: Array(6).fill(null),
            selectedStory: null,
            selectedSave: null,
            selectedOrigin: null,
            selectedArchetype: null,
            editingStory: null,
            isPlaying: false,
            isProcessing: false
        };

        const DAYS = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato', 'Domenica'];
        const SEASONS = ['Primavera', 'Estate', 'Autunno', 'Inverno'];

        // Azioni rapide per genere
        const GENRE_ACTIONS = {
            'Fantasy': [
                { icon: 'üí¨', label: 'Parla', prefix: 'Dico: "' },
                { icon: 'üëÅÔ∏è', label: 'Osserva', prefix: 'Osservo attentamente ' },
                { icon: '‚öîÔ∏è', label: 'Combatti', prefix: 'Attacco ' },
                { icon: 'üîÆ', label: 'Magia', prefix: 'Uso la magia per ' },
                { icon: 'ü§´', label: 'Furtivo', prefix: 'Mi muovo furtivamente verso ' },
                { icon: 'üéí', label: 'Cerca', prefix: 'Cerco ' }
            ],
            'Contemporaneo': [
                { icon: 'üí¨', label: 'Parla', prefix: 'Dico: "' },
                { icon: 'üëÅÔ∏è', label: 'Osserva', prefix: 'Osservo ' },
                { icon: 'üì±', label: 'Telefona', prefix: 'Chiamo ' },
                { icon: 'üîç', label: 'Cerca', prefix: 'Cerco informazioni su ' },
                { icon: 'üö∂', label: 'Vai', prefix: 'Vado a ' },
                { icon: 'üí≠', label: 'Pensa', prefix: 'Rifletto su ' }
            ],
            'Business': [
                { icon: 'üí¨', label: 'Parla', prefix: 'Dico: "' },
                { icon: 'üíº', label: 'Negozia', prefix: 'Propongo ' },
                { icon: 'üìä', label: 'Analizza', prefix: 'Analizzo ' },
                { icon: 'üìû', label: 'Contatta', prefix: 'Contatto ' },
                { icon: 'üí∞', label: 'Compra', prefix: 'Compro ' },
                { icon: 'üè∑Ô∏è', label: 'Vendi', prefix: 'Vendo ' }
            ],
            'Fantascienza': [
                { icon: 'üí¨', label: 'Parla', prefix: 'Dico: "' },
                { icon: 'üî¨', label: 'Scansiona', prefix: 'Scansiono ' },
                { icon: 'üíª', label: 'Hackera', prefix: 'Tento di hackerare ' },
                { icon: 'üîß', label: 'Ripara', prefix: 'Riparo ' },
                { icon: 'üöÄ', label: 'Pilota', prefix: 'Piloto verso ' },
                { icon: '‚ö°', label: 'Attiva', prefix: 'Attivo ' }
            ],
            'Cyberpunk': [
                { icon: 'üí¨', label: 'Parla', prefix: 'Dico: "' },
                { icon: 'üß†', label: 'Jack-in', prefix: 'Mi connetto a ' },
                { icon: 'üíâ', label: 'Potenzia', prefix: 'Uso un potenziamento per ' },
                { icon: 'üî´', label: 'Combatti', prefix: 'Sparo a ' },
                { icon: 'üïµÔ∏è', label: 'Indaga', prefix: 'Indago su ' },
                { icon: 'üí∏', label: 'Contratta', prefix: 'Contratto per ' }
            ],
            'Horror': [
                { icon: 'üí¨', label: 'Parla', prefix: 'Dico: "' },
                { icon: 'üëÅÔ∏è', label: 'Osserva', prefix: 'Osservo con attenzione ' },
                { icon: 'üî¶', label: 'Illumina', prefix: 'Illumino ' },
                { icon: 'üö™', label: 'Apri', prefix: 'Apro lentamente ' },
                { icon: 'üèÉ', label: 'Fuggi', prefix: 'Scappo verso ' },
                { icon: 'ü§´', label: 'Nasconditi', prefix: 'Mi nascondo ' }
            ],
            'Slice of Life': [
                { icon: 'üí¨', label: 'Parla', prefix: 'Dico: "' },
                { icon: '‚òï', label: 'Rilassati', prefix: 'Mi rilasso ' },
                { icon: 'üìö', label: 'Studia', prefix: 'Studio ' },
                { icon: 'üç≥', label: 'Cucina', prefix: 'Preparo ' },
                { icon: 'üö∂', label: 'Esci', prefix: 'Esco per ' },
                { icon: 'üì±', label: 'Messaggia', prefix: 'Scrivo a ' }
            ],
            'Thriller': [
                { icon: 'üí¨', label: 'Parla', prefix: 'Dico: "' },
                { icon: 'üîç', label: 'Indaga', prefix: 'Esamino ' },
                { icon: 'üì∑', label: 'Fotografa', prefix: 'Fotografo ' },
                { icon: 'üïµÔ∏è', label: 'Pedina', prefix: 'Seguo ' },
                { icon: 'üìÅ', label: 'Cerca prove', prefix: 'Cerco prove di ' },
                { icon: 'ü§ù', label: 'Interroga', prefix: 'Interrogo ' }
            ],
            'default': [
                { icon: 'üí¨', label: 'Parla', prefix: 'Dico: "' },
                { icon: 'üëÅÔ∏è', label: 'Osserva', prefix: 'Osservo ' },
                { icon: '‚úã', label: 'Interagisci', prefix: 'Interagisco con ' },
                { icon: '‚ùì', label: 'Chiedi', prefix: 'Chiedo ' },
                { icon: 'üö∂', label: 'Vai', prefix: 'Vado verso ' },
                { icon: 'üîç', label: 'Cerca', prefix: 'Cerco ' }
            ]
        };

        const ORIGINS = {
            ordinary: { name: 'Persona Comune', icon: 'üßë', desc: 'Background normale, potenziale straordinario', bonuses: { all: 1 } },
            wealthy: { name: 'Famiglia Ricca', icon: 'üíé', desc: 'Cresciuto negli agi, connessioni sociali', bonuses: { cha: 2, int: 1 } },
            street: { name: 'Strada', icon: 'üèöÔ∏è', desc: 'Cresciuto per le strade, saggio e furbo', bonuses: { dex: 2, wis: 1 } },
            academic: { name: 'Accademico', icon: 'üéì', desc: 'Istruzione elevata, mente brillante', bonuses: { int: 3 } },
            military: { name: 'Militare', icon: 'üéñÔ∏è', desc: 'Addestramento e disciplina', bonuses: { str: 2, con: 1 } },
            artistic: { name: 'Artista', icon: 'üé®', desc: 'Anima creativa, sensibilit√† unica', bonuses: { cha: 2, wis: 1 } },
            outsider: { name: 'Straniero', icon: 'üåç', desc: 'Viene da lontano, prospettiva diversa', bonuses: { wis: 2, dex: 1 } },
            mysterious: { name: 'Misterioso', icon: '‚ùì', desc: 'Passato oscuro, abilit√† nascoste', bonuses: { dex: 1, int: 1, cha: 1 } },
            supernatural: { name: 'Soprannaturale', icon: '‚ú®', desc: 'Non del tutto umano o con doni speciali', bonuses: { wis: 2, cha: 1 } },
            tech: { name: 'Tech-Native', icon: 'üíª', desc: 'Cresciuto con la tecnologia', bonuses: { int: 2, dex: 1 } }
        };

        const ARCHETYPES = {
            leader: { name: 'Leader', icon: 'üëî', desc: 'Guida e ispira gli altri', stat: 'cha', hp: 10, mp: 6, skills: ['Persuasione', 'Comando', 'Negoziazione'] },
            fighter: { name: 'Combattente', icon: '‚öîÔ∏è', desc: 'Esperto nel conflitto fisico', stat: 'str', hp: 14, mp: 2, skills: ['Combattimento', 'Resistenza', 'Intimidazione'] },
            thinker: { name: 'Pensatore', icon: 'üß†', desc: 'Risolve problemi con l\'intelletto', stat: 'int', hp: 8, mp: 10, skills: ['Analisi', 'Ricerca', 'Pianificazione'] },
            smooth: { name: 'Diplomatico', icon: 'üó£Ô∏è', desc: 'Parla e convince', stat: 'cha', hp: 8, mp: 8, skills: ['Eloquenza', 'Empatia', 'Raggiro'] },
            shadow: { name: 'Ombra', icon: 'üåë', desc: 'Agisce nell\'ombra', stat: 'dex', hp: 10, mp: 4, skills: ['Furtivit√†', 'Agilit√†', 'Sotterfugio'] },
            creator: { name: 'Creatore', icon: 'üîß', desc: 'Costruisce e ripara', stat: 'int', hp: 8, mp: 8, skills: ['Artigianato', 'Invenzione', 'Riparazione'] },
            healer: { name: 'Guaritore', icon: 'üíö', desc: 'Cura e supporta', stat: 'wis', hp: 8, mp: 10, skills: ['Medicina', 'Supporto', 'Intuizione'] },
            explorer: { name: 'Esploratore', icon: 'üß≠', desc: 'Scopre e si adatta', stat: 'wis', hp: 10, mp: 6, skills: ['Sopravvivenza', 'Orientamento', 'Percezione'] },
            merchant: { name: 'Mercante', icon: 'üí∞', desc: 'Compra, vende, guadagna', stat: 'cha', hp: 8, mp: 6, skills: ['Contrattazione', 'Valutazione', 'Rete di contatti'] },
            specialist: { name: 'Specialista', icon: 'üéØ', desc: 'Eccelle in un campo specifico', stat: 'dex', hp: 10, mp: 6, skills: ['Precisione', 'Concentrazione', 'Expertise'] }
        };

        const ITEMS = {
            healing: { name: 'Kit Pronto Soccorso', icon: 'ü©π', type: 'consumable', effect: { health: 30 } },
            energy: { name: 'Energy Drink', icon: 'ü•§', type: 'consumable', effect: { stamina: 30 } },
            focus: { name: 'Caff√® Forte', icon: '‚òï', type: 'consumable', effect: { mana: 20 } },
            snack: { name: 'Snack', icon: 'üç´', type: 'consumable', effect: { stamina: 15 } },
            tool: { name: 'Multi-tool', icon: 'üîß', type: 'misc' },
            phone: { name: 'Smartphone', icon: 'üì±', type: 'misc' },
            flashlight: { name: 'Torcia', icon: 'üî¶', type: 'misc' }
        };

        // ==================== UTILITIES ====================
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);

        function notify(msg, type = 'info') {
            const n = document.createElement('div');
            n.className = `notification ${type}`;
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        }

        function mod(val) { return Math.floor((val - 10) / 2); }

        function roll(sides) { return Math.floor(Math.random() * sides) + 1; }

        function save() {
            localStorage.setItem('dnd_v2', JSON.stringify({
                stories: G.stories, saves: G.saves, settings: G.settings
            }));
        }

        // ==================== TIME MANAGEMENT ====================
        function advanceTime(minutes) {
            G.time.minute += minutes;
            
            while (G.time.minute >= 60) {
                G.time.minute -= 60;
                G.time.hour++;
            }
            
            while (G.time.hour >= 24) {
                G.time.hour -= 24;
                G.time.day++;
                
                // Advance day of week
                const dayIndex = DAYS.indexOf(G.time.dayName);
                G.time.dayName = DAYS[(dayIndex + 1) % 7];
                
                // Change season every 30 days
                if (G.time.day % 30 === 0) {
                    const seasonIndex = SEASONS.indexOf(G.time.season);
                    G.time.season = SEASONS[(seasonIndex + 1) % 4];
                }
            }
            
            updateTimeDisplay();
        }

        function waitUntilHour(targetHour) {
            let minutesToWait = 0;
            let currentHour = G.time.hour;
            let currentMinute = G.time.minute;
            
            if (targetHour <= currentHour) {
                // Wait until next day
                minutesToWait = (24 - currentHour + targetHour) * 60 - currentMinute;
            } else {
                minutesToWait = (targetHour - currentHour) * 60 - currentMinute;
            }
            
            advanceTime(minutesToWait);
            return minutesToWait;
        }

        function getTimePeriod() {
            const h = G.time.hour;
            if (h >= 5 && h < 8) return { icon: 'üåÖ', name: 'Alba' };
            if (h >= 8 && h < 12) return { icon: '‚òÄÔ∏è', name: 'Mattina' };
            if (h >= 12 && h < 14) return { icon: 'üåû', name: 'Mezzogiorno' };
            if (h >= 14 && h < 18) return { icon: 'üå§Ô∏è', name: 'Pomeriggio' };
            if (h >= 18 && h < 21) return { icon: 'üåÜ', name: 'Sera' };
            if (h >= 21 || h < 1) return { icon: 'üåô', name: 'Notte' };
            return { icon: 'üåë', name: 'Notte fonda' };
        }

        function getTimeString() {
            const h = G.time.hour.toString().padStart(2, '0');
            const m = G.time.minute.toString().padStart(2, '0');
            return `${h}:${m}`;
        }

        function getFullTimeString() {
            const period = getTimePeriod();
            return `${G.time.dayName}, Giorno ${G.time.day} - ${getTimeString()} (${period.name})`;
        }

        function updateTimeDisplay() {
            const period = getTimePeriod();
            $('time-day').textContent = `${G.time.dayName} G${G.time.day}`;
            $('time-clock').textContent = getTimeString();
            $('time-period').textContent = period.icon;
            
            if ($('wait-current-time')) {
                $('wait-current-time').textContent = getFullTimeString();
            }
        }

        function resetTime() {
            G.time = {
                day: 1,
                hour: 8,
                minute: 0,
                dayName: 'Luned√¨',
                season: 'Primavera'
            };
        }

        // ==================== DYNAMIC QUICK ACTIONS ====================
        function getGenreActions(setting) {
            if (!setting) return GENRE_ACTIONS['default'];
            
            const settingLower = setting.toLowerCase();
            
            if (settingLower.includes('fantasy') || settingLower.includes('medievale') || settingLower.includes('epico')) {
                return GENRE_ACTIONS['Fantasy'];
            }
            if (settingLower.includes('business') || settingLower.includes('economia')) {
                return GENRE_ACTIONS['Business'];
            }
            if (settingLower.includes('cyberpunk')) {
                return GENRE_ACTIONS['Cyberpunk'];
            }
            if (settingLower.includes('fantascienza') || settingLower.includes('sci-fi') || settingLower.includes('spazio')) {
                return GENRE_ACTIONS['Fantascienza'];
            }
            if (settingLower.includes('horror') || settingLower.includes('gotico')) {
                return GENRE_ACTIONS['Horror'];
            }
            if (settingLower.includes('slice') || settingLower.includes('vita') || settingLower.includes('universit√†')) {
                return GENRE_ACTIONS['Slice of Life'];
            }
            if (settingLower.includes('thriller') || settingLower.includes('mistero') || settingLower.includes('detective')) {
                return GENRE_ACTIONS['Thriller'];
            }
            if (settingLower.includes('contemporaneo') || settingLower.includes('moderno')) {
                return GENRE_ACTIONS['Contemporaneo'];
            }
            
            return GENRE_ACTIONS['default'];
        }

        function updateQuickActions() {
            const actions = G.currentStory ? getGenreActions(G.currentStory.setting) : GENRE_ACTIONS['default'];
            
            const html = actions.map(a => `
                <button class="quick-btn" data-prefix="${a.prefix}">
                    ${a.icon} ${a.label}
                </button>
            `).join('');
            
            $('quick-actions').innerHTML = html;
            
            // Rebind click handlers
            $$('.quick-btn').forEach(btn => {
                btn.onclick = () => {
                    const prefix = btn.dataset.prefix;
                    const input = $('action-input');
                    input.value = prefix;
                    input.focus();
                };
            });
        }

        function load() {
            const d = localStorage.getItem('dnd_v2');
            if (d) {
                const p = JSON.parse(d);
                G.stories = p.stories || [];
                G.saves = p.saves || Array(6).fill(null);
                G.settings = { ...G.settings, ...p.settings };
            }
            if (G.stories.length === 0) {
                G.stories = [
                    { 
                        id: 1, 
                        title: 'La Cripta dei Sussurri', 
                        setting: 'Fantasy Gotico', 
                        difficulty: 'normal', 
                        desc: 'Un mondo gotico dove la nebbia avvolge antichi cimiteri e cripte dimenticate nascondono segreti terribili. Il villaggio di Ravenhollow vive nella paura di ci√≤ che si cela sotto terra.', 
                        personality: 'Narratore misterioso e atmosferico. Crea tensione e suspense. Usa descrizioni cupe ma evocative.', 
                        depth: 'Gli NPC hanno paure e segreti. Le scelte morali hanno conseguenze. La morte √® sempre vicina.',
                        prologue: 'La nebbia si alza lenta dal cimitero mentre attraversi i cancelli arrugginiti di Ravenhollow. Il villaggio sembra deserto, le finestre delle case sprangate. Solo la locanda "Il Corvo Stanco" mostra segni di vita: una luce fioca filtra dalle imposte e il suono di voci sommesse raggiunge le tue orecchie.'
                    },
                    { 
                        id: 2, 
                        title: 'Scalata al Successo', 
                        setting: 'Contemporaneo / Business', 
                        difficulty: 'normal', 
                        desc: 'Una storia moderna ambientata in una citt√† contemporanea. Hai ereditato un piccolo negozio e sogni di costruire un impero commerciale. Clienti, fornitori, concorrenti e opportunit√† ti aspettano.', 
                        personality: 'Narratore realistico ma coinvolgente. Dialoghi naturali e moderni. Attenzione ai dettagli della vita quotidiana e del business.', 
                        depth: 'Ogni decisione economica ha conseguenze. I rapporti con clienti e fornitori contano. La reputazione si costruisce nel tempo.',
                        prologue: 'La serranda si alza con un cigolio familiare. "Emporio Rossi" - la vecchia insegna di tuo nonno pende ancora sopra la porta. L\'avvocato ti ha dato le chiavi ieri, insieme a un conto in banca quasi vuoto e una montagna di fatture arretrate. Ma questo negozio √® tuo adesso. Una signora anziana si ferma davanti alla vetrina, curiosa. "Oh, finalmente riaprite? Che bella notizia!"'
                    },
                    { 
                        id: 3, 
                        title: 'Colonia Titan-7', 
                        setting: 'Fantascienza', 
                        difficulty: 'hard', 
                        desc: 'Anno 2347. Sei un tecnico nella colonia mineraria Titan-7, sulla luna di Saturno. Quando i sensori rilevano forme di vita sconosciute nelle miniere profonde, la routine si trasforma in incubo.', 
                        personality: 'Narratore tecnico ma umano. Tensione crescente in stile Alien. Dettagli scientifici credibili mescolati a orrore cosmico.', 
                        depth: 'Le risorse sono limitate. Ogni modulo della base ha funzioni specifiche. Le decisioni influenzano la sopravvivenza di tutti.',
                        prologue: 'L\'allarme ti sveglia alle 03:47 ora della colonia. "Anomalia sismica rilevata - Settore Minerario Delta" annuncia la voce sintetica del computer. Niente di strano, su Titan le scosse sono frequenti. Ma quando controlli i monitor, il sangue ti si gela: la squadra di perforazione Delta non risponde. E qualcosa si muove nelle telecamere del tunnel 7.'
                    },
                    { 
                        id: 4, 
                        title: 'Universit√† della Vita', 
                        setting: 'Slice of Life / Drama', 
                        difficulty: 'easy', 
                        desc: 'Sei uno studente universitario al primo anno. Tra esami, coinquilini impossibili, amori complicati e la ricerca di te stesso, ogni giorno √® un\'avventura. Crescerai, cambierai, e forse troverai il tuo posto nel mondo.', 
                        personality: 'Narratore intimo e riflessivo. Dialoghi autentici tra giovani. Momenti di leggerezza alternati a profondit√† emotiva.', 
                        depth: 'Le relazioni evolvono nel tempo. Le scelte accademiche e personali modellano il futuro. I personaggi secondari hanno le loro storie.',
                        prologue: 'La stanza 304 del dormitorio puzza di vernice fresca e solitudine. Tre letti, tre scrivanie, due coinquilini che ancora non conosci. Uno di loro ha gi√† appeso poster di band che non hai mai sentito, l\'altro sembra aver portato un\'intera libreria. Dal corridoio arrivano risate e musica. √à il tuo primo giorno di universit√†, e tutto sembra possibile.'
                    },
                    { 
                        id: 5, 
                        title: 'Tokyo Neon', 
                        setting: 'Cyberpunk', 
                        difficulty: 'hard', 
                        desc: 'Tokyo, 2089. Grattacieli infiniti, pioggia acida, e corporazioni che controllano tutto. Sei un runner freelance nei bassifondi digitali, cercando di sopravvivere tra hacker, yakuza cyborg e intelligenze artificiali ribelli.', 
                        personality: 'Narratore noir e cinico. Atmosfera blade-runner. Gergo cyberpunk, neon e cromo, pioggia costante.', 
                        depth: 'La tecnologia ha un costo. Le corporazioni sono nemici invisibili. Nel sottobosco digitale, la fiducia √® merce rara.',
                        prologue: 'La pioggia batte sui vetri rinforzati del tuo appartamento-capsula nel Blocco 47. Il messaggio lampeggia sull\'interfaccia neurale: un lavoro, anonimo, pagamento in crypto. "Estrazione dati. Torre Mishima. Stanotte." Sotto, le coordinate e un anticipo gi√† nel tuo wallet. Fuori dalla finestra, le luci al neon di Shinjuku pulsano come un cuore malato.'
                    },
                    { 
                        id: 6, 
                        title: 'Il Torneo dei Campioni', 
                        setting: 'Fantasy Epico', 
                        difficulty: 'easy', 
                        desc: 'Il glorioso Regno di Valdoria ospita il pi√π grande torneo del continente. Cavalieri, mercenari e avventurieri si sfidano per onore, gloria e la mano della Principessa Elara.', 
                        personality: 'Narratore epico e cavalleresco. Enfatizza onore, coraggio e rivalit√†. I combattimenti sono spettacolari.', 
                        depth: 'Ogni avversario ha una storia e motivazioni. Le alleanze contano. La politica di corte nasconde intrighi.',
                        prologue: 'Le bandiere colorate sventolano nel vento mentre ti avvicini alle porte della capitale. Il rombo della folla riempie l\'aria: il Torneo dei Campioni sta per iniziare. Davanti all\'ingresso, un araldo in livrea reale sta registrando i partecipanti, mentre guerrieri di ogni tipo si aggirano mostrando le loro armi.'
                    }
                ];
                save();
            }
        }

        // ==================== SCREENS ====================
        function showScreen(id) {
            $$('.screen').forEach(s => s.classList.remove('active'));
            $(id).classList.add('active');
        }

        function openModal(id) {
            $(id).classList.add('active');
        }

        function closeModal(id) {
            $(id).classList.remove('active');
        }

        function closeAllModals() {
            $$('.modal-overlay').forEach(m => m.classList.remove('active'));
        }

        // ==================== HOME ====================
        function updateHome() {
            $('btn-continue').disabled = !G.isPlaying;
        }

        // ==================== CHARACTER ====================
        function createCharacter(name, origin, archetype) {
            const o = ORIGINS[origin], a = ARCHETYPES[archetype];
            const attrs = { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 };
            
            if (o.bonuses) {
                if (o.bonuses.all) Object.keys(attrs).forEach(k => attrs[k] += o.bonuses.all);
                else Object.entries(o.bonuses).forEach(([k,v]) => { if(attrs[k]) attrs[k] += v; });
            }
            if (o.maluses) Object.entries(o.maluses).forEach(([k,v]) => { if(attrs[k]) attrs[k] += v; });

            const conMod = mod(attrs.con);
            
            G.character = {
                name, origin, archetype, level: 1,
                health: { cur: a.hp + conMod, max: a.hp + conMod },
                mana: { cur: a.mp + Math.max(0, mod(attrs.int)), max: a.mp + Math.max(0, mod(attrs.int)) },
                stamina: { cur: 100, max: 100 },
                exp: { cur: 0, need: 100 },
                attrs,
                skills: {},
                inventory: [
                    { id: 'healing', count: 2 },
                    { id: 'snack', count: 3 },
                    { id: 'phone', count: 1 }
                ],
                equipment: { weapon: null, armor: null, accessory: null },
                gold: 100, silver: 0, copper: 0
            };
            
            a.skills.forEach(s => G.character.skills[s] = mod(attrs[a.stat]));
        }

        function updateCharacterUI() {
            if (!G.character) return;
            const c = G.character;
            const o = ORIGINS[c.origin], a = ARCHETYPES[c.archetype];

            // Mini stats in topbar
            $('mini-health').style.width = `${(c.health.cur / c.health.max) * 100}%`;
            $('mini-mana').style.width = `${(c.mana.cur / c.mana.max) * 100}%`;

            // Character modal
            $('char-portrait').textContent = a.icon;
            $('char-name').textContent = c.name;
            $('char-class').textContent = `${o.name} ‚Ä¢ ${a.name} Lv. ${c.level}`;

            $('stat-health').style.width = `${(c.health.cur / c.health.max) * 100}%`;
            $('stat-health-text').textContent = `${c.health.cur}/${c.health.max}`;
            $('stat-mana').style.width = `${(c.mana.cur / c.mana.max) * 100}%`;
            $('stat-mana-text').textContent = `${c.mana.cur}/${c.mana.max}`;
            $('stat-stamina').style.width = `${(c.stamina.cur / c.stamina.max) * 100}%`;
            $('stat-stamina-text').textContent = `${c.stamina.cur}/${c.stamina.max}`;
            $('stat-exp').style.width = `${(c.exp.cur / c.exp.need) * 100}%`;
            $('stat-exp-text').textContent = `${c.exp.cur}/${c.exp.need}`;

            // Attributes
            const attrsHtml = ['str','dex','con','int','wis','cha'].map(at => `
                <div class="attr-box">
                    <div class="attr-name">${at.toUpperCase()}</div>
                    <div class="attr-value">${c.attrs[at]}</div>
                    <div class="attr-mod">${mod(c.attrs[at]) >= 0 ? '+' : ''}${mod(c.attrs[at])}</div>
                </div>
            `).join('');
            $('attrs-grid').innerHTML = attrsHtml;

            // Skills
            const skillsHtml = Object.entries(c.skills).map(([name, val]) => `
                <div class="skill-item">
                    <span>${name}</span>
                    <span class="${val >= 0 ? 'skill-bonus' : 'skill-malus'}">${val >= 0 ? '+' : ''}${val}</span>
                </div>
            `).join('');
            $('skills-list').innerHTML = skillsHtml || '<div class="skill-item">Nessuna abilit√†</div>';

            // Inventory modal
            $('inv-gold').textContent = c.gold;

            let invHtml = '';
            for (let i = 0; i < 16; i++) {
                const item = c.inventory[i];
                if (item) {
                    const data = ITEMS[item.id] || { icon: '‚ùì', name: item.id };
                    invHtml += `<div class="inv-slot" data-idx="${i}" title="${data.name}">${data.icon}${item.count > 1 ? `<span class="count">x${item.count}</span>` : ''}</div>`;
                } else {
                    invHtml += `<div class="inv-slot"></div>`;
                }
            }
            $('inv-grid').innerHTML = invHtml;
        }

        // ==================== STORIES ====================
        function updateStoriesUI() {
            const html = G.stories.map((s, i) => `
                <div class="story-card ${G.selectedStory === i ? 'selected' : ''}" data-idx="${i}">
                    <div class="story-card-title">${s.title}</div>
                    <div class="story-card-desc">${s.desc?.substring(0, 80) || ''}...</div>
                </div>
            `).join('');
            $('stories-list').innerHTML = html || '<p>Nessuna storia. Creane una!</p>';

            $('btn-edit-story').disabled = G.selectedStory === null;
            $('btn-delete-story').disabled = G.selectedStory === null;

            // New game story select
            $('new-game-story').innerHTML = G.stories.map((s, i) => 
                `<option value="${i}">${s.title}</option>`
            ).join('');
        }

        function openStoryEditor(story = null) {
            G.editingStory = story;
            $('edit-story-title').value = story?.title || '';
            $('edit-story-setting').value = story?.setting || 'medieval';
            $('edit-story-difficulty').value = story?.difficulty || 'normal';
            $('edit-story-desc').value = story?.desc || '';
            $('edit-story-personality').value = story?.personality || '';
            $('edit-story-depth').value = story?.depth || '';
            $('edit-story-prologue').value = story?.prologue || '';
            openModal('modal-story-editor');
        }

        function saveStoryFromEditor() {
            const story = {
                id: G.editingStory?.id || Date.now(),
                title: $('edit-story-title').value || 'Nuova Storia',
                setting: $('edit-story-setting').value,
                difficulty: $('edit-story-difficulty').value,
                desc: $('edit-story-desc').value,
                personality: $('edit-story-personality').value,
                depth: $('edit-story-depth').value,
                prologue: $('edit-story-prologue').value
            };

            if (G.editingStory) {
                const idx = G.stories.findIndex(s => s.id === G.editingStory.id);
                if (idx !== -1) G.stories[idx] = story;
            } else {
                G.stories.push(story);
            }

            save();
            closeModal('modal-story-editor');
            updateStoriesUI();
            notify('Storia salvata!', 'success');
        }

        // ==================== SAVES ====================
        function updateSavesUI() {
            let html = '';
            for (let i = 0; i < 6; i++) {
                const s = G.saves[i];
                let info = 'Vuoto';
                if (s) {
                    const timeInfo = s.time ? `G${s.time.day} ${s.time.hour.toString().padStart(2,'0')}:${s.time.minute.toString().padStart(2,'0')}` : '';
                    info = `${s.character?.name || '?'} - ${s.story?.title || '?'} ${timeInfo ? '‚Ä¢ ' + timeInfo : ''}`;
                }
                html += `
                    <div class="save-slot ${G.selectedSave === i ? 'selected' : ''}" data-idx="${i}">
                        <div class="save-slot-title">Slot ${i + 1}</div>
                        <div class="save-slot-info">${info}</div>
                    </div>
                `;
            }
            $('saves-list').innerHTML = html;
        }

        function saveToSlot() {
            if (G.selectedSave === null || !G.isPlaying) return;
            G.saves[G.selectedSave] = {
                timestamp: Date.now(),
                character: JSON.parse(JSON.stringify(G.character)),
                story: G.currentStory,
                storyLog: G.storyLog,
                history: G.history,
                time: JSON.parse(JSON.stringify(G.time))
            };
            save();
            updateSavesUI();
            notify(`Salvato in Slot ${G.selectedSave + 1}!`, 'success');
        }

        function loadFromSlot() {
            if (G.selectedSave === null) return;
            const s = G.saves[G.selectedSave];
            if (!s) { notify('Slot vuoto!', 'error'); return; }

            G.character = s.character;
            G.currentStory = s.story;
            G.storyLog = s.storyLog || [];
            G.history = s.history || [];
            G.time = s.time || { day: 1, hour: 8, minute: 0, dayName: 'Luned√¨', season: 'Primavera' };
            G.isPlaying = true;

            closeAllModals();
            startGameUI();
            notify('Partita caricata!', 'success');
        }

        // ==================== GAME ====================
        function startNewGame() {
            const storyIdx = parseInt($('new-game-story').value);
            const name = $('new-game-name').value || 'Protagonista';

            if (G.selectedOrigin === null || G.selectedArchetype === null) {
                notify('Seleziona origine e archetipo!', 'error');
                return;
            }
            if (G.stories.length === 0) {
                notify('Crea prima una storia!', 'error');
                return;
            }

            G.currentStory = G.stories[storyIdx];
            createCharacter(name, G.selectedOrigin, G.selectedArchetype);
            resetTime();
            G.storyLog = [];
            G.history = [];
            G.isPlaying = true;

            closeAllModals();
            startGameUI();
        }

        function startGameUI() {
            showScreen('game-screen');
            updateCharacterUI();
            updateQuickActions();
            updateTimeDisplay();

            $('story-scroll').innerHTML = '';
            G.storyLog.forEach(e => addStoryEntry(e.text, e.type, false));

            if (G.storyLog.length === 0 && G.currentStory?.prologue) {
                addStoryEntry(G.currentStory.prologue, 'narrator');
                generateAI('L\'avventura inizia...', true);
            }

            updateHome();
        }

        function exitGame() {
            if (confirm('Uscire? I progressi non salvati saranno persi.')) {
                showScreen('home-screen');
            }
        }

        function addStoryEntry(text, type, log = true) {
            const div = document.createElement('div');
            div.className = `story-entry ${type}`;
            
            // Format text properly
            let formatted = text
                // Convert newlines to proper paragraphs
                .split(/\n\n+/)
                .map(para => para.trim())
                .filter(para => para.length > 0)
                .map(para => `<p>${para.replace(/\n/g, '<br>')}</p>`)
                .join('');
            
            // If no paragraphs were created, just use the text
            if (!formatted) {
                formatted = `<p>${text.replace(/\n/g, '<br>')}</p>`;
            }
            
            div.innerHTML = formatted;
            $('story-scroll').appendChild(div);
            $('story-scroll').scrollTop = $('story-scroll').scrollHeight;

            if (log) G.storyLog.push({ text, type, time: Date.now() });
        }

        function displaySuggestions(suggestions) {
            const area = $('suggestions-area');
            const list = $('suggestions-list');

            if (!suggestions || suggestions.length === 0) {
                area.style.display = 'none';
                return;
            }

            const typeIcons = {
                'dialogo': 'üí¨',
                'azione': '‚ö°',
                'esplorazione': 'üîç',
                'combattimento': '‚öîÔ∏è',
                'default': 'üí°'
            };

            list.innerHTML = suggestions.map((s, i) => `
                <button class="suggestion-btn" data-idx="${i}">
                    <span class="suggestion-type">${typeIcons[s.type.toLowerCase()] || typeIcons.default} ${s.type}</span>
                    ${s.text}
                </button>
            `).join('');

            area.style.display = 'block';

            // Click handlers for suggestions
            list.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.onclick = () => {
                    const suggestion = suggestions[parseInt(btn.dataset.idx)];
                    $('action-input').value = suggestion.text;
                    area.style.display = 'none';
                    sendAction();
                };
            });
        }

        function sendAction() {
            const input = $('action-input');
            const action = input.value.trim();
            if (!action || G.isProcessing) return;

            // Hide suggestions when acting
            $('suggestions-area').style.display = 'none';

            input.value = '';
            addStoryEntry(`‚û§ ${action}`, 'player');
            generateAI(action);
        }

        // ==================== AI ====================
        async function generateAI(action, isStart = false) {
            if (G.isProcessing || !G.currentStory) return;
            G.isProcessing = true;
            $('btn-send').disabled = true;

            addStoryEntry('<span class="loading-dots">Il narratore sta scrivendo</span>', 'system');

            try {
                const response = await callAI(action, isStart);

                // Remove loading
                const last = $('story-scroll').lastChild;
                if (last?.textContent?.includes('scrivendo')) last.remove();

                parseAIResponse(response);
                G.history.push({ role: 'user', content: action });
                G.history.push({ role: 'assistant', content: response });

            } catch (err) {
                const last = $('story-scroll').lastChild;
                if (last?.textContent?.includes('scrivendo')) last.remove();
                addStoryEntry(`‚ö†Ô∏è Errore: ${err.message}`, 'system');
            }

            G.isProcessing = false;
            $('btn-send').disabled = false;
        }

        async function callAI(action, isStart) {
            const s = G.settings;
            const story = G.currentStory;
            const c = G.character;
            const o = ORIGINS[c.origin], a = ARCHETYPES[c.archetype];
            const period = getTimePeriod();

            const lengths = { short: '150-250 parole', medium: '250-400 parole', long: '400-600 parole' };

            const systemPrompt = `Sei il Narratore di un gioco di ruolo interattivo. Scrivi in italiano, in modo chiaro e coinvolgente.

GENERE E AMBIENTAZIONE: ${story.setting}
${story.desc || ''}

STILE NARRATIVO: ${story.personality || 'Narratore evocativo che crea atmosfera'}

TEMPO ATTUALE:
- Giorno: ${G.time.day} (${G.time.dayName})
- Ora: ${getTimeString()} - ${period.name}
- Stagione: ${G.time.season}

PROTAGONISTA:
- Nome: ${c.name}
- Background: ${o.name} (${o.desc})
- Ruolo: ${a.name} (${a.desc})
- Livello esperienza: ${c.level}
- Condizione: ${c.health.cur}/${c.health.max} HP | ${c.mana.cur}/${c.mana.max} Energia
- Risorse: ${c.gold} soldi

COME SCRIVERE:
- Scrivi ${lengths[s.length]} di narrazione fluida e immersiva
- TIENI CONTO DEL MOMENTO DELLA GIORNATA (${period.name}) nelle descrizioni
- Se √® notte, descrivi l'oscurit√†, le luci artificiali, la stanchezza
- Se √® mattina, descrivi la luce del sole, l'inizio delle attivit√†
- Il tempo influenza cosa succede (negozi aperti/chiusi, persone in giro, ecc.)
- ADATTA il tono e lo stile al genere della storia
- I personaggi parlano tra virgolette: "Benvenuto!"
- Le azioni/espressioni tra asterischi: *sorride*
- NON usare liste numerate o markdown
- Scrivi in paragrafi naturali

Per far passare il tempo nella storia, indica:
[TEMPO: +30] per 30 minuti
[TEMPO: +60] per 1 ora
[TEMPO: +1440] per 1 giorno

Per eventi di gioco:
[MECCANICA: soldi=50] per guadagni/perdite
[MECCANICA: danno=10] per danni
[MECCANICA: exp=25] per esperienza

Suggerimenti opzionali alla fine:
[SUGGERIMENTO: tipo | testo]`;

            let userMsg;
            if (isStart) {
                userMsg = `Inizia la storia. √à ${G.time.dayName}, ${period.name} (${getTimeString()}). ${story.prologue || 'Il protagonista inizia la sua avventura.'} 

Descrivi la scena iniziale tenendo conto del momento della giornata. Introduci l'ambiente e almeno un personaggio interessante.`;
            } else {
                userMsg = `[${G.time.dayName} ${getTimeString()} - ${period.name}]

Il giocatore: ${action}

Continua la narrazione. Tieni conto dell'ora del giorno nelle descrizioni e nelle reazioni dei personaggi.`;
            }

            let endpoint, model, headers;

            if (s.model === 'openrouter' && s.openrouterKey) {
                endpoint = 'https://openrouter.ai/api/v1/chat/completions';
                model = 'google/gemma-3-27b-it';
                headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${s.openrouterKey}` };
            } else if (s.groqKey) {
                endpoint = 'https://api.groq.com/openai/v1/chat/completions';
                model = 'llama-3.1-8b-instant';
                headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${s.groqKey}` };
            } else {
                throw new Error('Configura le API keys nelle Impostazioni!');
            }

            const recentHistory = G.history.slice(-6);

            const body = {
                model,
                messages: [
                    { role: 'system', content: systemPrompt },
                    ...recentHistory,
                    { role: 'user', content: userMsg }
                ],
                temperature: 0.8,
                max_tokens: 1500
            };

            const res = await fetch(endpoint, { method: 'POST', headers, body: JSON.stringify(body) });
            if (!res.ok) {
                const errData = await res.json().catch(() => ({}));
                throw new Error(errData.error?.message || `Errore API: ${res.status}`);
            }
            const data = await res.json();
            return data.choices[0].message.content;
        }

        function parseAIResponse(response) {
            // Extract time changes
            const timeRe = /\[TEMPO:\s*\+?(\d+)\]/gi;
            let m;
            while ((m = timeRe.exec(response)) !== null) {
                const mins = parseInt(m[1]);
                advanceTime(mins);
                const timeStr = mins >= 1440 ? `${Math.floor(mins/1440)} giorno/i` : 
                               mins >= 60 ? `${Math.floor(mins/60)} ora/e` : `${mins} minuti`;
                addStoryEntry(`‚è∞ Passa ${timeStr}...`, 'system');
            }

            // Extract mechanics
            const mechRe = /\[MECCANICA:\s*([^\]]+)\]/gi;
            while ((m = mechRe.exec(response)) !== null) {
                applyMechanic(m[1]);
            }

            // Extract suggestions (new format)
            const suggRe = /\[SUGGERIMENTO:\s*([^|]+)\|([^\]]+)\]/gi;
            const suggestions = [];
            while ((m = suggRe.exec(response)) !== null) {
                suggestions.push({ type: m[1].trim(), text: m[2].trim() });
            }

            // Also convert old format choices to suggestions
            const choiceRe = /\[SCELTA:\s*([^|\]]+)[^\]]*\]/gi;
            while ((m = choiceRe.exec(response)) !== null) {
                suggestions.push({ type: 'azione', text: m[1].trim() });
            }

            // Clean response thoroughly
            let clean = response
                .replace(/\[TEMPO:[^\]]*\]/gi, '')
                .replace(/\[MECCANICA:[^\]]*\]/gi, '')
                .replace(/\[SUGGERIMENTO:[^\]]*\]/gi, '')
                .replace(/\[SCELTA:[^\]]*\]/gi, '')
                .replace(/\[TIRO:[^\]]*\]/gi, '')
                .replace(/\[AZIONE:[^\]]*\]/gi, '')
                .replace(/#{1,6}\s*/g, '')
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                .replace(/\_\_([^_]+)\_\_/g, '$1')
                .replace(/```[^`]*```/g, '')
                .replace(/`([^`]+)`/g, '$1')
                .replace(/\*([^*\n]+)\*/g, '<em>$1</em>')
                .replace(/\n{3,}/g, '\n\n')
                .trim();

            if (!clean || clean.length < 10) {
                clean = "Il narratore sembra confuso... Riprova con un'altra azione.";
            }

            addStoryEntry(clean, 'narrator');
            displaySuggestions(suggestions);
            updateCharacterUI();
            updateTimeDisplay();
        }

        function applyMechanic(mech) {
            const [type, val] = mech.split('=').map(s => s.trim().toLowerCase());
            const v = parseInt(val) || 0;
            const c = G.character;

            switch (type) {
                case 'danno': case 'damage':
                    c.health.cur = Math.max(0, c.health.cur - v);
                    addStoryEntry(`üíî -${v} HP`, 'system');
                    break;
                case 'cura': case 'heal':
                    c.health.cur = Math.min(c.health.max, c.health.cur + v);
                    addStoryEntry(`üíö +${v} HP`, 'system');
                    break;
                case 'oro': case 'gold': case 'soldi': case 'money':
                    c.gold += v;
                    addStoryEntry(`üíµ ${v >= 0 ? '+' : ''}${v} soldi`, 'system');
                    break;
                case 'exp': case 'esperienza':
                    c.exp.cur += v;
                    addStoryEntry(`‚≠ê +${v} EXP`, 'system');
                    checkLevelUp();
                    break;
                case 'energia': case 'mana':
                    c.mana.cur = Math.min(c.mana.max, Math.max(0, c.mana.cur + v));
                    addStoryEntry(`üíô ${v >= 0 ? '+' : ''}${v} energia`, 'system');
                    break;
            }
        }

        function checkLevelUp() {
            const c = G.character;
            while (c.exp.cur >= c.exp.need) {
                c.exp.cur -= c.exp.need;
                c.level++;
                c.exp.need = Math.floor(c.exp.need * 1.5);
                c.health.max += 5;
                c.health.cur = c.health.max;
                c.mana.max += 3;
                c.mana.cur = c.mana.max;
                notify(`üéâ Livello ${c.level}!`, 'success');
                addStoryEntry(`üéâ LIVELLO ${c.level}!`, 'system');
            }
        }

        // ==================== DICE ====================
        function rollDice(sides) {
            const result = roll(sides);
            $('dice-result').textContent = `üé≤ D${sides}: ${result}`;
            addStoryEntry(`üé≤ D${sides}: ${result}`, 'dice-roll');
        }

        // ==================== INIT ====================
        function init() {
            load();
            updateHome();
            updateStoriesUI();
            updateSavesUI();

            // Load settings
            $('set-groq-key').value = G.settings.groqKey || '';
            $('set-openrouter-key').value = G.settings.openrouterKey || '';
            $('set-model').value = G.settings.model || 'groq';
            $('set-length').value = G.settings.length || 'medium';
            $('set-autoroll').checked = G.settings.autoRoll !== false;

            // Origin/Archetype grids
            $('origin-grid').innerHTML = Object.entries(ORIGINS).map(([k, v]) => `
                <div class="creation-option" data-origin="${k}" title="${v.desc}">
                    <div class="creation-icon">${v.icon}</div>
                    <div class="creation-name">${v.name}</div>
                </div>
            `).join('');

            $('archetype-grid').innerHTML = Object.entries(ARCHETYPES).map(([k, v]) => `
                <div class="creation-option" data-archetype="${k}" title="${v.desc}">
                    <div class="creation-icon">${v.icon}</div>
                    <div class="creation-name">${v.name}</div>
                </div>
            `).join('');

            // HOME BUTTONS
            $('btn-continue').onclick = () => showScreen('game-screen');
            $('btn-new-game').onclick = () => openModal('modal-new-game');
            $('btn-load-game').onclick = () => { updateSavesUI(); openModal('modal-saves'); };
            $('btn-stories').onclick = () => { updateStoriesUI(); openModal('modal-stories'); };
            $('btn-settings').onclick = () => openModal('modal-settings');

            // GAME TOPBAR
            $('btn-exit').onclick = exitGame;
            $('btn-save-quick').onclick = () => { updateSavesUI(); openModal('modal-saves'); };
            $('btn-dice').onclick = () => openModal('modal-dice');
            $('btn-inventory').onclick = () => { updateCharacterUI(); openModal('modal-inventory'); };
            $('btn-character').onclick = () => { updateCharacterUI(); openModal('modal-character'); };
            $('btn-wait').onclick = () => { updateTimeDisplay(); openModal('modal-wait'); };

            // WAIT MODAL HANDLERS
            $$('.wait-btn').forEach(btn => {
                btn.onclick = () => {
                    const mins = parseInt(btn.dataset.minutes);
                    advanceTime(mins);
                    closeAllModals();
                    const timeStr = mins >= 1440 ? `${Math.floor(mins/1440)} giorno/i` : 
                                   mins >= 60 ? `${Math.floor(mins/60)} ora/e` : `${mins} minuti`;
                    addStoryEntry(`‚è∞ Passano ${timeStr}... Ora sono le ${getTimeString()}, ${getTimePeriod().name}.`, 'system');
                    generateAI(`√à passato del tempo. Ora √® ${getFullTimeString()}. Descrivi brevemente cosa √® cambiato nella scena o cosa succede.`);
                };
            });
            $('btn-wait-until').onclick = () => {
                const targetHour = parseInt($('wait-until-hour').value);
                const waited = waitUntilHour(targetHour);
                closeAllModals();
                if (waited > 0) {
                    addStoryEntry(`‚è∞ Aspetti fino alle ${targetHour.toString().padStart(2,'0')}:00...`, 'system');
                    generateAI(`√à passato del tempo. Ora √® ${getFullTimeString()}. Descrivi brevemente cosa √® cambiato.`);
                }
            };

            // INPUT
            $('btn-send').onclick = sendAction;
            $('action-input').onkeypress = e => { if (e.key === 'Enter') sendAction(); };

            // DICE
            $$('.dice-btn').forEach(btn => {
                btn.onclick = () => rollDice(parseInt(btn.dataset.sides));
            });

            // STORIES
            $('stories-list').onclick = e => {
                const card = e.target.closest('.story-card');
                if (card) {
                    G.selectedStory = parseInt(card.dataset.idx);
                    updateStoriesUI();
                }
            };
            $('btn-create-story').onclick = () => openStoryEditor();
            $('btn-edit-story').onclick = () => { if (G.selectedStory !== null) openStoryEditor(G.stories[G.selectedStory]); };
            $('btn-delete-story').onclick = () => {
                if (G.selectedStory !== null && confirm('Eliminare questa storia?')) {
                    G.stories.splice(G.selectedStory, 1);
                    G.selectedStory = null;
                    save();
                    updateStoriesUI();
                }
            };
            $('btn-save-story').onclick = saveStoryFromEditor;

            // NEW GAME
            $('origin-grid').onclick = e => {
                const opt = e.target.closest('.creation-option');
                if (opt) {
                    $$('#origin-grid .creation-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    G.selectedOrigin = opt.dataset.origin;
                }
            };
            $('archetype-grid').onclick = e => {
                const opt = e.target.closest('.creation-option');
                if (opt) {
                    $$('#archetype-grid .creation-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    G.selectedArchetype = opt.dataset.archetype;
                }
            };
            $('btn-start-game').onclick = startNewGame;

            // SAVES
            $('saves-list').onclick = e => {
                const slot = e.target.closest('.save-slot');
                if (slot) {
                    G.selectedSave = parseInt(slot.dataset.idx);
                    updateSavesUI();
                }
            };
            $('btn-save-to-slot').onclick = saveToSlot;
            $('btn-load-from-slot').onclick = loadFromSlot;
            $('btn-delete-slot').onclick = () => {
                if (G.selectedSave !== null && G.saves[G.selectedSave] && confirm('Eliminare questo salvataggio?')) {
                    G.saves[G.selectedSave] = null;
                    save();
                    updateSavesUI();
                }
            };

            // SETTINGS
            $('btn-save-settings').onclick = () => {
                G.settings.groqKey = $('set-groq-key').value;
                G.settings.openrouterKey = $('set-openrouter-key').value;
                G.settings.model = $('set-model').value;
                G.settings.length = $('set-length').value;
                G.settings.autoRoll = $('set-autoroll').checked;
                save();
                notify('Impostazioni salvate!', 'success');
            };
            $('btn-reset-all').onclick = () => {
                if (confirm('‚ö†Ô∏è Cancellare TUTTI i dati?')) {
                    localStorage.removeItem('dnd_v2');
                    location.reload();
                }
            };

            // MODAL CLOSES
            $$('.modal-close, [data-close]').forEach(btn => {
                btn.onclick = () => {
                    const id = btn.dataset.close || btn.closest('.modal-overlay')?.id;
                    if (id) closeModal(id);
                };
            });

            // Close on overlay click
            $$('.modal-overlay').forEach(overlay => {
                overlay.onclick = e => {
                    if (e.target === overlay) closeModal(overlay.id);
                };
            });

            // Inventory item use
            $('inv-grid').onclick = e => {
                const slot = e.target.closest('.inv-slot');
                if (slot && slot.dataset.idx !== undefined) {
                    const idx = parseInt(slot.dataset.idx);
                    const item = G.character.inventory[idx];
                    if (item) {
                        const data = ITEMS[item.id];
                        if (data?.type === 'consumable' && data.effect) {
                            Object.entries(data.effect).forEach(([k, v]) => {
                                if (G.character[k]) {
                                    G.character[k].cur = Math.min(G.character[k].cur + v, G.character[k].max);
                                }
                            });
                            item.count--;
                            if (item.count <= 0) G.character.inventory.splice(idx, 1);
                            notify(`Usato ${data.name}!`, 'success');
                            addStoryEntry(`[Usato ${data.name}]`, 'system');
                            updateCharacterUI();
                        }
                    }
                }
            };
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
